## 1. TCP/IP 网络模型有哪几层
### 1.1 应用层
应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。
而且应用层是工作在操作系统中的用户态，传输层及以下则工作在内核态。

socket 是操作系统概念。一般在操作系统内核实现了网络栈例如tcp、udp协议，应用层通过socket调用网络栈。

### 1.2 传输层
在传输层会有两个传输协议，分别是 TCP 和 UDP。
- TCP：相较UDP，多了如流量控制、超时重传、拥塞控制等
	- 传输层的数据包大小超过 **MSS**（TCP 最大报文段长度） ，就要将数据包分块。
	- ![](../../img/Pasted%20image%2020221209201612.png)
- UDP：只负责发送**数据包**，不需要分段（所以当数据量较大时，只能交给IP层去分片），不保证数据包是否能抵达对方

### 1.3 网络层
 IP 协议（_Internet Protocol_）：IP 协议会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 **MTU**（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的 IP 报文。
![](../../img/Pasted%20image%2020221209201805.png)

### 1.4 网络接口层
生成了 IP 头部之后，接下来要交给**网络接口层**（Link Layer）在 IP 头部的前面加上 MAC 头部，并封装成数据帧（Data frame）发送到网络上。
![](../../img/Pasted%20image%2020221209202026.png)
IP 头部中的接收方 IP 地址表示网络包的目的地，通过这个地址我们就可以判断要将包发到哪里，但在以太网的世界中，这个思路是行不通的。

什么是以太网呢？电脑上的以太网接口，Wi-Fi接口，以太网交换机、路由器上的千兆，万兆以太网口，还有网线，它们都是以太网的组成部分。以太网就是一种在「局域网」内，把附近的设备连接起来，使它们之间可以进行通讯的技术。

以太网在判断网络包目的地时和 IP 的方式不同，因此必须采用相匹配的方式才能在以太网中将包发往目的地，而 MAC 头部就是干这个用的，所以，在以太网进行通讯要用到 MAC 地址。

MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 ARP 协议获取对方的 MAC 地址。

所以说，网络接口层主要为网络层提供「链路级别」传输的服务，负责在以太网、WiFi 这样的底层网络上发送原始数据包，工作在网卡这个层次，使用 MAC 地址来标识网络上的设备。

>以太网是一种局域网，而局域网却不一定是以太网，只是由于目前大多数的局域网是以太网，所以一般说局域网，大家都默认为以太网。
>所谓以太网，是一种总线型局域网，是施乐公司创建。局域网的拓扑结构有很多实现方式，有星型、环形、总线型等。但是这些年来的经验看，以太网，也就是总线型的是最成功的，应用最广泛的。

### 1.5 总结
综上所述，TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。
![](../../img/Pasted%20image%2020221209202339.png)
再给大家贴一下每一层的封装格式：
![](../../img/Pasted%20image%2020221209202349.png)

网络接口层的传输单位是**帧（frame）**，IP 层的传输单位是**包（packet）**，TCP 层的传输单位是**段（segment）**，HTTP 的传输单位则是**消息或报文（message）**。但这些名词并没有什么本质的区分，可以统称为数据包。


## 2. 键入网址到网页显示，期间发生了什么？
### 2.1 HTTP协议
首先需要对`URL`进行解析，从而生成发送给Web服务器的请求信息。
![](../../img/Pasted%20image%2020221209203219.png)
对 `URL` 进行解析之后，浏览器确定了 Web 服务器和文件名，接下来就是根据这些信息来生成 HTTP 请求消息了。
![](../../img/Pasted%20image%2020221209203550.png)

### 2.2 DNS
通过浏览器解析 URL 并生成 HTTP 消息后，需要委托操作系统将消息发送给 `Web` 服务器。

但在发送之前，还有一项工作需要完成，那就是**查询服务器域名对应的 IP 地址**，因为委托操作系统发送消息时，必须提供通信对象的 IP 地址。

所以，有一种服务器就专门保存了 `Web` 服务器域名与 `IP` 的对应关系，它就是 `DNS` 服务器。

DNS 中的域名都是用**句点**来分隔的，比如 `www.server.com`，这里的句点代表了不同层次之间的**界限**。

在域名中，**越靠右**的位置表示其层级**越高**。

实际上域名最后还有一个点，比如 `www.server.com.`，这个最后的一个点代表根域名。

也就是，`.` 根域是在最顶层，它的下一层就是 `.com` 顶级域，再下面是 `server.com`

所以域名的层级关系类似一个树状结构：
-   根 DNS 服务器（.）
-   顶级域 DNS 服务器（.com）
-   权威 DNS 服务器（server.com）
![](../../img/Pasted%20image%2020221209204042.png)

根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中。

这样一来，任何 DNS 服务器就都可以找到并访问根域 DNS 服务器了。

因此，客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器。

域名解析的工作流程:
1.  客户端首先会发出一个 DNS 请求，问 www.server.com 的 IP 是啥，并发给本地 DNS 服务器（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。
2.  本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 www.server.com 的 IP 地址吗？” 根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路。
3.  根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”
4.  本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com 的 IP 地址吗？”
5.  顶级域名服务器说：“我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”。
6.  本地 DNS 于是转向问权威 DNS 服务器：“老三，www.server.com对应的IP是啥呀？” server.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。
7.  权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
8.  本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。

![](../../img/Pasted%20image%2020221209204209.png)

那是不是每次解析域名都要经过那么多的步骤呢？

当然不是了，还有缓存这个东西的嘛。

浏览器会先看自身有没有对这个域名的缓存，如果有，就直接返回，如果没有，就去问操作系统，操作系统也会去看自己的缓存，如果有，就直接返回，如果没有，再去 hosts 文件看，也没有，才会去问「本地 DNS 服务器」。

>当我们输入这个网址回车的时候，浏览器会首先查询浏览器的缓存，这个缓存存活时间可能只有`1`分钟，如果没找到，则去查询本地的`dns`缓存和`hosts`文件，如果有`www.baidu.com`这个域名对应的`ip`，则直接通过这个`ip`访问网站服务器。如果本地的`dns`缓存和`hosts`文件没找到，这时候就会把请求发送给网卡配置信息里的`dns`服务器，默认有两个，只有当`dns1`不能访问时，才会使用`dns2`。我们也称网卡配置信息里的`dns`为`local dns`，这时候`local dns`会先查询它的缓存，有没有`www.baidu.com`相应的记录，如果有，则返回给用户，如果没有，就会访问根域名服务器进行后续的解析请求及响应流程


>Hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从Hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统会再将网址提交DNS域名解析服务器进行IP地址的解析。

>DNS缓存和hosts文件不是一回事。
>往往会出现尽管修改了`hosts`文件，但是有时候并不会生效，发现还是会解析成之前的地址，这就是因为DNS缓存没有刷新

### 2.3 协议栈
通过 DNS 获取到 IP 后，就可以把 HTTP 的传输工作交给操作系统中的**协议栈**。
![](../../img/Pasted%20image%2020221209204705.png)
应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。协议栈的上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，这两个传输协议会接受应用层的委托执行收发数据的操作。

协议栈的下面一半是用 IP 协议控制网络包收发操作，在互联网上传数据时，数据会被切分成一块块的网络包，而将网络包发送给对方的操作就是由 IP 负责的。

此外 IP 中还包括 `ICMP` 协议和 `ARP` 协议。

-   `ICMP` 用于告知网络包传送过程中产生的错误以及各种控制信息。
-   `ARP` 用于根据 IP 地址查询相应的以太网 MAC 地址。（TCP/IP模型中属于IP层，在OSI模型中属于链路层）

IP 下面的网卡驱动程序负责控制网卡硬件，而最下面的网卡则负责完成实际的收发操作，也就是对网线中的信号执行发送和接收操作。

### 2.4 TCP


