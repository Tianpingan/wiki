## 什么是TCP
TCP是**面向连接的**、**可靠的**、**基于字节流**的传输层通信协议

## 什么是TCP连接
简单来说就是，**用于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括Socket、序列号和窗口大小称为连接。**
所以我们可以知道，建立一个 TCP 连接是需要客户端与服务端端达成上述三个信息的共识。

-   **Socket**：由 IP 地址和端口号组成
-   **序列号**：用来解决乱序问题等
-   **窗口大小**：用来做流量控制

## 如何唯一确定一个TCP连接？
TCP 四元组可以唯一的确定一个连接，四元组包括如下：

-   源地址
-   源端口
-   目的地址
-   目的端口

服务端最大并发 TCP 连接数远不能达到理论上限，会受以下因素影响：
- 文件描述符限制
- 内存限制

## UDP
UDP 不提供复杂的控制机制，利用 IP 提供面向「无连接」的通信服务。
**TCP 和 UDP 区别：**

_1. 连接_

-   TCP 是面向连接的传输层协议，传输数据前先要建立连接。
-   UDP 是不需要连接，即刻传输数据。

_2. 服务对象_

-   TCP 是一对一的两点服务，即一条连接只有两个端点。
-   UDP 支持一对一、一对多、多对多的交互通信

_3. 可靠性_

-   TCP 是可靠交付数据的，数据可以无差错、不丢失、不重复、按序到达。
-   UDP 是尽最大努力交付，不保证可靠交付数据。但是我们可以基于 UDP 传输协议实现一个可靠的传输协议，比如 QUIC 协议，具体可以参见这篇文章：[如何基于 UDP 协议实现可靠传输？(opens new window)](https://xiaolincoding.com/network/3_tcp/quic.html)

_4. 拥塞控制、流量控制_

-   TCP 有拥塞控制和流量控制机制，保证数据传输的安全性。
-   UDP 则没有，即使网络非常拥堵了，也不会影响 UDP 的发送速率。

_5. 首部开销_

-   TCP 首部长度较长，会有一定的开销，首部在没有使用「选项」字段时是 `20` 个字节，如果使用了「选项」字段则会变长的。
-   UDP 首部只有 8 个字节，并且是固定不变的，开销较小。

_6. 传输方式_

-   TCP 是流式传输，没有边界，但保证顺序和可靠。
-   UDP 是一个包一个包的发送，是有边界的，但可能会丢包和乱序。

_7. 分片不同_

-   TCP 的数据大小如果大于 MSS 大小，则会在传输层进行分片，目标主机收到后，也同样在传输层组装 TCP 数据包，如果中途丢失了一个分片，只需要传输丢失的这个分片。
-   UDP 的数据大小如果大于 MTU 大小，则会在 IP 层进行分片，目标主机收到后，在 IP 层组装完数据，接着再传给传输层。

![](../../img/Pasted%20image%2020221213085720.png)

**为什么 UDP 头部没有「首部长度」字段，而 TCP 头部有「首部长度」字段呢？**
原因是 TCP 有**可变长**的「选项」字段，而 UDP 头部长度则是**不会变化**的，无需多一个字段去记录 UDP 的首部长度。

**为什么 UDP 头部有「包长度」字段，而 TCP 头部则没有「包长度」字段呢？**
先说说 TCP 是如何计算负载数据长度：

![](https://imgconvert.csdnimg.cn/aHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL3hpYW9saW5jb2Rlci9JbWFnZUhvc3QyLyVFOCVBRSVBMSVFNyVBRSU5NyVFNiU5QyVCQSVFNyVCRCU5MSVFNyVCQiU5Qy9UQ1AtJUU0JUI4JTg5JUU2JUFDJUExJUU2JThGJUExJUU2JTg5JThCJUU1JTkyJThDJUU1JTlCJTlCJUU2JUFDJUExJUU2JThDJUE1JUU2JTg5JThCLzEzLmpwZw?x-oss-process=image/format,png)

其中 IP 总长度 和 IP 首部长度，在 IP 首部格式是已知的。TCP 首部长度，则是在 TCP 首部格式已知的，所以就可以求得 TCP 数据的长度。

大家这时就奇怪了问：“ UDP 也是基于 IP 层的呀，那 UDP 的数据长度也可以通过这个公式计算呀？ 为何还要有「包长度」呢？”

这么一问，确实感觉 UDP 「包长度」是冗余的。

我查阅了很多资料，我觉得有两个比较靠谱的说法：

-   第一种说法：因为为了网络设备硬件设计和处理方便，首部长度需要是 `4`字节的整数倍。如果去掉 UDP 「包长度」字段，那 UDP 首部长度就不是 `4` 字节的整数倍了，所以我觉得这可能是为了补全 UDP 首部长度是 `4` 字节的整数倍，才补充了「包长度」字段。
-   第二种说法：如今的 UDP 协议是基于 IP 协议发展的，而当年可能并非如此，依赖的可能是别的不提供自身报文长度或首部长度的网络层协议，因此 UDP 报文首部需要有长度字段以供计算。

**TCP 和 UDP 可以使用同一个端口吗？**
答案：**可以的**。

